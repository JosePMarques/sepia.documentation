
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Exercise 1 &#8212; SEPIA 0.7 documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Check You Progress 1" href="Exercise1_progress1.html" />
    <link rel="prev" title="(f)MRI Toolkit 2019" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Exercise1_progress1.html" title="Check You Progress 1"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="(f)MRI Toolkit 2019"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SEPIA 0.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">(f)MRI Toolkit 2019</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="exercise-1">
<span id="fmritoolkit2019-exercise1"></span><h1>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="objectives">
<h2>Objectives<a class="headerlink" href="#objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Understanding the data required for QSM</li>
<li>Understanding why we need to correct the phase data before mapping the magnetic susceotibility</li>
</ul>
</div>
<div class="section" id="understanding-multi-echo-gre-data">
<h2>Understanding multi-echo GRE data<a class="headerlink" href="#understanding-multi-echo-gre-data" title="Permalink to this headline">¶</a></h2>
<p>As mentioned in the introduction, water protons resonate in different frequencies because of the tissue magnetic susceptibility. The frequency difference in brain tissues can be detected as the difference in phase accumulation over time (see Eq. <a class="reference internal" href="#equation-pft">(1)</a>). Therefore, the phase measurement of the MRI signal allows us to map the magnetic susceptibility of brain tissues.</p>
<div class="math" id="equation-pft">
<p><span class="eqno">(1)<a class="headerlink" href="#equation-pft" title="Permalink to this equation">¶</a></span><img src="../../_images/math/f364d195e4ba56392d83647ff89d2d87036df2dd.png" alt="phase = frequency \times time"/></p>
</div><p>To compute a magnetic susceptibility map, multi-echo gradient-echo images are usually used because it can provide phase images. Now, please go to the exercise directory which is located in ~/qsm_tutorial/. You can use the following command in the terminal:</p>
<p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/qsm_tutorial/</span></code></p>
<p>To view the content of the directory using the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">ls</span></code></p>
<p>You will see two NIfTI images (.nii.gz) and a few JSON files (.json) in the directory. The two NIfTI images correspond to the magnitude (mag.nii.gz) and the phase MR signal (phase.nii.gz). Both of them are 4D data, with the first 3 dimensions containing spatial information (i.e the image of the brain) and echo time (i.e. the time we sampled data) in the 4th dimension. The JSON files contain important information such as the echo times (TE) and magnetic field strength (in Tesla), which allow us to compute the magnetic susceptibility with the correct unit.</p>
<p>Let’s take a look of the magnitude images. You can do that by calling the image viewer FSLeyes in the terminal:</p>
<p><code class="docutils literal notranslate"><span class="pre">fsleyes</span> <span class="pre">mag.nii.gz</span></code></p>
<p>Once you opened the magnitude images in the viewer, click the movie button to see how the brain images change over time.</p>
<img alt="../../_images/movie_button.png" src="../../_images/movie_button.png" />
<p>You can also press <code class="docutils literal notranslate"><span class="pre">ctr+3</span></code> to see the plot of signal evolution at different brain tissues. Select a few data points in the brain, how do you describe the signal curve?</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="Exercise1_progress1.html">Check You Progress 1</a></li>
</ul>
</div>
<p>Let’s have a look of the phase images. You can close the viewer and use the following command in the terminal:</p>
<p><code class="docutils literal notranslate"><span class="pre">fsleyes</span> <span class="pre">phase.nii.gz</span></code></p>
<p>The phase images look very different compared to the magnitude images and with the current display windowing it is hard to see any contrast of brain tissues. Adjust the windowing to [-3,1], you should be able to identify some brain structures. You might wonder why the tissue contrasts are somehow ‘hidden’ in the data. Before answering this question, let’s focus on how the phase developed over time which is the main objective of this exercise. Change the window back to [-3,3] and click the movie button again to see the phase development over time. Based on Eq. <a class="reference internal" href="#equation-pft">(1)</a>, it is expected the phase increases/decreases monotonically. In other words, we should observe the phase images become brighter/dimmer in the later echoes. What do you see in the later echo images?</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="Exercise1_progress2.html">Check You Progress 2</a></li>
</ul>
</div>
<p>It seems that in some regions they follow the description in Eq.1 but it is certainly not the case in some regions. Let press <code class="docutils literal notranslate"><span class="pre">ctr+3</span></code> again to see the phase curve in different positions of the brain. Can you identify the cause of the problem?</p>
<ol class="upperalpha simple">
<li>Somebody screwed up the acquisition</li>
<li>The subject moved during the scan</li>
<li>The phase is bounded to certain values</li>
<li>Fast switching gradient introduced extra phase</li>
</ol>
<p>[Answer]()</p>
<p>In order to correctly estimate the frequency shift using Eq.1, this phase problem has to be addressed otherwise we will compute wrong magnetic susceptibility in those affected regions. To unwrap the phase and map to the correct values, SEPIA provides several algorithms to do the job.</p>
</div>
<div class="section" id="sepia">
<h2>SEPIA<a class="headerlink" href="#sepia" title="Permalink to this headline">¶</a></h2>
<p>SEPIA is a pipeline tool to process phase images in Matlab. To use SEPIA, please open a Matlab application in the cluster by typing:</p>
<p><code class="docutils literal notranslate"><span class="pre">matlab2016b</span></code>,</p>
<p>click OK, leave the runtime as default and specify the memory requirement as 10 (GB).</p>
<a class="reference internal image-reference" href="../../_images/matlab_job.png"><img alt="../../_images/matlab_job.png" class="align-center" src="../../_images/matlab_job.png" style="width: 389.3px; height: 218.45px;" /></a>
<p>Once you have the Matlab opened, first go to the tutorial directory and add the SEPIA home directory to the Matlab Path. You can simply do this by typing the following command in the Matlab’s command’s window:</p>
<p><code class="docutils literal notranslate"><span class="pre">addpath('~/qsm_tutorial/sepia/');</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The copy of SEPIA that you have in the tutorial directory already included all the external toolboxes required by SEPIA. If you want to know how to setup SEPIA from the start after today tutorial, you can refer to the other wiki pages to see how it can be done.</p>
</div>
<p>Now, enter <code class="docutils literal notranslate"><span class="pre">sepia</span></code> in the command window. A graphical user interface should be popped up momentarily. The first tab in SEPIA provides a one-stop application to process the raw phase data to a QSM map. Alternatively, we can break down the processing pipeline into several steps and SEPIA also supports this approach.</p>
<a class="reference internal image-reference" href="../../_images/sepia_layout.png"><img alt="../../_images/sepia_layout.png" class="align-center" src="../../_images/sepia_layout.png" style="width: 698.5999999999999px; height: 508.9px;" /></a>
<p>The first thing you need to do before using the Sepia’s pipeline is to create a header file that contains all essential information for the rest of the processing. To do this select the <strong>Utility</strong> tab and then select <strong>Get header info</strong> in the drop-down menu. This function provides several ways to extract the header information from different types of files. With all the NifTI images and JSON files stored in the same place, we can use ‘Op 2’ routine. Click ‘Open’ next to ‘Op 2’ and select ~/qsm_tutorial as the input. The output of the header file will be stored in the same directory as your input by default. Click <strong>Save header</strong> to save the file. When you see the message ‘’ in the command window, the file is saved.</p>
<p>Go the <strong>Phase unwrapping</strong> tab and you will see two panels under the tab: the <strong>I/O</strong> is for data input and output and the <strong>Total field recovery and phase unwrapping</strong> is for true phase accumulation estimation.</p>
<a class="reference internal image-reference" href="../../_images/phase_unwrap_tab.png"><img alt="../../_images/phase_unwrap_tab.png" class="align-center" src="../../_images/phase_unwrap_tab.png" style="width: 700.6999999999999px; height: 239.39999999999998px;" /></a>
<p>In the <strong>I/O</strong> panel, select the ~/qsm_tutorial/ in the <strong>Input directory</strong> and check the <strong>FSL brain extraction</strong>. Having an accurate brain mask is important to produce a high-quality QSM map.</p>
<p>In the <strong>Total field recovery and phase unwrapping</strong> panel, keep the <strong>Echo phase combination</strong> method as ‘Optimum weights’ and change the <strong>Phase unwrapping</strong> method to ‘Laplacian STI Suite’. Then click the <strong>Start</strong> button.</p>
<p>You should now see some messages are displayed in the command window. Once it finishes, you will see the message <code class="docutils literal notranslate"><span class="pre">Done</span></code>. Now we can check the output results. Use FSLeyes to open the <em>Sepia_unwrapped-phase.nii.gz</em> in the output directory and see the phase development over time again. Can you see all the zipper lines are gone and the changes of phase behave as predict by Eq. <a class="reference internal" href="#equation-pft">(1)</a>?</p>
<p>Open the <em>Sepia_total-field.nii.gz</em> file in the output directory. This is the result we needed in the next exercise. This map is the average phase accumulation between two successive echoes. With this image, we have the phase accumulation and we also know the exact time to develop this phase. We can then compute the frequency shift by rewriting Eq. <a class="reference internal" href="#equation-pft">(1)</a> to:</p>
<div class="math" id="equation-fpt">
<p><span class="eqno">(2)<a class="headerlink" href="#equation-fpt" title="Permalink to this equation">¶</a></span><img src="../../_images/math/cc10814bb6c3c5a24cdfa7bc890eed2ddc2f0649.png" alt="frequency = \frac{phase}{time}"/></p>
</div><p>Proceed to <a class="reference internal" href="Exercise2.html#fmritoolkit2019-exercise2"><span class="std std-ref">Exercise 2</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Exercise 1</a><ul>
<li><a class="reference internal" href="#objectives">Objectives</a></li>
<li><a class="reference internal" href="#understanding-multi-echo-gre-data">Understanding multi-echo GRE data</a><ul>
</ul>
</li>
<li><a class="reference internal" href="#sepia">SEPIA</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">(f)MRI Toolkit 2019</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Exercise1_progress1.html"
                        title="next chapter">Check You Progress 1</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorial/fMRItoolkit2019/Exercise1.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Exercise1_progress1.html" title="Check You Progress 1"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="(f)MRI Toolkit 2019"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SEPIA 0.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >(f)MRI Toolkit 2019</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Kwok-Shing Chan.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>