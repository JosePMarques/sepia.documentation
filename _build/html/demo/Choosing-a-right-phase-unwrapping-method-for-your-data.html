
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Choosing a right phase unwrapping method for your data &#8212; SEPIA 0.7 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="(f)MRI Toolkit 2019" href="../tutorial/fMRItoolkit2019/index.html" />
    <link rel="prev" title="QSM Standalone" href="../gui/QSM-standalone.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../tutorial/fMRItoolkit2019/index.html" title="(f)MRI Toolkit 2019"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../gui/QSM-standalone.html" title="QSM Standalone"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SEPIA 0.7 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="choosing-a-right-phase-unwrapping-method-for-your-data">
<h1>Choosing a right phase unwrapping method for your data<a class="headerlink" href="#choosing-a-right-phase-unwrapping-method-for-your-data" title="Permalink to this headline">¶</a></h1>
<p>SEPIA provides a range of phase unwrapping methods from the supported toolboxes. In this demonstration, I will try to show the differences between two main phase unwrapping methods: (1) region growing and (2) Laplacian-based - an important processing step to reveal the (true) phase of MRI gradient echo data for QSM processing.</p>
<div class="section" id="data-preparation">
<h2>Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h2>
<p>The <em>in vivo</em> test data was downloaded from <a class="reference external" href="http://pre.weill.cornell.edu/mri/pages/qsm.html">Cornell MRI lab</a> and converted to NIfTI format by <a class="reference external" href="https://github.com/xiangruili/dicm2nii">dicm2nii</a>.
FSL’s BET was used to extract the brain mask to improve the processing result.</p>
</div>
<div class="section" id="processing">
<h2>Processing<a class="headerlink" href="#processing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="test-1-unwrapping-the-phase-with-a-small-amount-of-wrapping-effect">
<h3>Test 1: Unwrapping the phase with a small amount of wrapping effect<a class="headerlink" href="#test-1-unwrapping-the-phase-with-a-small-amount-of-wrapping-effect" title="Permalink to this headline">¶</a></h3>
<p>To begin with, let have a look of the phase image from the 1st echo GRE data (TE=3.6ms)</p>
<img alt="../_images/wrap-phase_e-1.png" src="../_images/wrap-phase_e-1.png" />
<p>Under a linear model assumption the phase of each voxel over time can be expressed by the following equation:</p>
<div class="math">
<p><img src="../_images/math/048256d2db0ca820f7bf8df27d06ad61cfe996f8.png" alt="phase = angular frequency \times time [1]"/></p>
</div><p>However, this phase value is constrained in the interval of [-pi,pi) in the MRI phase data. Any value that is outside of this interval will be wrapped back to this interval (see red arrows). For QSM processing, it is important to unwrap the phase such that the true frequency shift inside the voxel can be computed using the above equation.</p>
<p>To unwrap the phase images, there are two main methods being used: (1) <strong>region growing</strong> and (2) <strong>Laplacian operator</strong>. In SEPIA, you can use the following commands to access the methods:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% region growing</span>
<span class="n">unwrappedPhase</span> <span class="p">=</span> <span class="n">UnwrapPhaseMacro</span><span class="p">(</span><span class="n">wrappedPhase</span><span class="p">,</span><span class="n">matrixSize</span><span class="p">,</span><span class="n">voxelSize</span><span class="p">,</span><span class="s">&#39;method&#39;</span><span class="p">,</span><span class="s">&#39;rg&#39;</span><span class="p">,</span><span class="s">&#39;magn&#39;</span><span class="p">,</span><span class="n">magn</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
<span class="c">% Laplacian</span>
<span class="n">unwrappedPhase</span> <span class="p">=</span> <span class="n">UnwrapPhaseMacro</span><span class="p">(</span><span class="n">wrappedPhase</span><span class="p">,</span><span class="n">matrixSize</span><span class="p">,</span><span class="n">voxelSize</span><span class="p">,</span><span class="s">&#39;method&#39;</span><span class="p">,</span><span class="s">&#39;laplacian&#39;</span><span class="p">);</span>
<span class="n">unwrappedPhase</span> <span class="p">=</span> <span class="n">UnwrapPhaseMacro</span><span class="p">(</span><span class="n">wrappedPhase</span><span class="p">,</span><span class="n">matrixSize</span><span class="p">,</span><span class="n">voxelSize</span><span class="p">,</span><span class="s">&#39;method&#39;</span><span class="p">,</span><span class="s">&#39;laplacian_stisuite&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="region-growing">
<h4>Region growing<a class="headerlink" href="#region-growing" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/unwrap-phase_rg_e-1.png" src="../_images/unwrap-phase_rg_e-1.png" />
</div>
<div class="section" id="laplacian">
<h4>Laplacian<a class="headerlink" href="#laplacian" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/unwrap-phase_laplacian_e-1.png" src="../_images/unwrap-phase_laplacian_e-1.png" />
<p>Both methods can unwrap the 1st echo phase successfully, but they show different brightness under the same dynamic range (-2pi,2pi). <strong>Where does this difference come from?</strong></p>
<p>Let’s compare the unwrapped phase with the original wrapped phase. In Matlab this can be done by:
<code class="docutils literal notranslate"><span class="pre">phase_residual</span> <span class="pre">=</span> <span class="pre">angle(exp(1i*wrappedPhase)</span> <span class="pre">.*</span> <span class="pre">conj(exp(1i*unwrappedPhase)));</span></code></p>
<p>Here are the residual phase maps form</p>
</div>
<div class="section" id="id1">
<h4>Region growing<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/phase-diff_rg_e-1.png" src="../_images/phase-diff_rg_e-1.png" />
<p>The residual map shows 0s everywhere. This means that the unwrapped phase image is just a summation of 2xpixN (N is an integer)  of the original wrapped phase map (which is unwrapped in this case).</p>
</div>
<div class="section" id="id2">
<h4>Laplacian<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/phase-diff_laplacian_e-1.png" src="../_images/phase-diff_laplacian_e-1.png" />
<p>This shows that the unwrapped phase from the Laplacian method is not an exact summation of 2xpixN to the original phase. It is due to the fact that the Laplacian operator removes some of the harmonic field components from the original phase image (which is the slowly-varying field in this image). Since the harmonic field will also be removed from later on processing steps in QSM processing, Laplacian unwrapping is still a good method to unwrap the signal phase in this case (we didn’t see any brain structure in the residual map except veins).</p>
</div>
</div>
<div class="section" id="test-2-unwrapping-the-phase-with-a-large-amount-of-wrapping-effect">
<h3>Test 2: Unwrapping the phase with a large amount of wrapping effect<a class="headerlink" href="#test-2-unwrapping-the-phase-with-a-large-amount-of-wrapping-effect" title="Permalink to this headline">¶</a></h3>
<p>From Eq.1, we can see that phase accumulated with an increase of time. Therefore when we look at the later echo(es), we can see more phase wrapping appeared and here is an example at the 8th echo (TE=45ms) of the testing data</p>
<img alt="../_images/wrap-phase_e-8.png" src="../_images/wrap-phase_e-8.png" />
<p>We can use the same unwrapping methods as we did before and look at the results again:</p>
<div class="section" id="id3">
<h4>Region growing<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/unwrap-phase_rg_e-8.png" src="../_images/unwrap-phase_rg_e-8.png" />
<p>The region growing method can still produce a reliable result in most of the brain regions even in the presence of a large wrapping effect. Yet, unwrapping errors can be observed in the posterior blood vessel and in the temporal lobe (see arrows). It is apparently caused by the relatively large susceptibility field together with the low SNR in these regions.</p>
</div>
<div class="section" id="id4">
<h4>Laplacian<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/unwrap-phase_laplacian_e-8.png" src="../_images/unwrap-phase_laplacian_e-8.png" />
<p>The unwrapped phase is smooth from the Laplacian method but is it truly better than that of the region growing method? Let’s compare the unwrapped phase with the original phase to see more detail!</p>
<p>Here are the residual phase maps form</p>
</div>
<div class="section" id="id5">
<h4>Region growing<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/phase-diff_rg_e-8.png" src="../_images/phase-diff_rg_e-8.png" />
<p>Once again, the residual map shows 0s everywhere, suggesting that the unwrapped phase is a summation of 2xpixN of the original phase even though it didn’t unwrap the phase correctly in some regions.</p>
</div>
<div class="section" id="id6">
<h4>Laplacian<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<img alt="../_images/phase-diff_laplacian_e-8.png" src="../_images/phase-diff_laplacian_e-8.png" />
<p>More harmonic components were removed compared to the case of 1st echo. In addition, we can start seeing brain structures (arrows indicating the red nuclei) in the residual phase which is not optimal for QSM. Nonetheless, the incorrect unwrapped phase generated by region growing method can actually create more problems in later QSM processing.</p>
</div>
</div>
<div class="section" id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<p>Region growing method should be used in the first attempt to unwrap the raw phase image. It is reliable for a small amount of wrapped effect and represents the true phase value (for successful unwrapping). Laplacian method is very robust to unwrap a large amount of phase wrapping by trading a small degree of accuracy in the unwrapping results.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Choosing a right phase unwrapping method for your data</a><ul>
<li><a class="reference internal" href="#data-preparation">Data preparation</a></li>
<li><a class="reference internal" href="#processing">Processing</a><ul>
<li><a class="reference internal" href="#test-1-unwrapping-the-phase-with-a-small-amount-of-wrapping-effect">Test 1: Unwrapping the phase with a small amount of wrapping effect</a><ul>
<li><a class="reference internal" href="#region-growing">Region growing</a></li>
<li><a class="reference internal" href="#laplacian">Laplacian</a></li>
<li><a class="reference internal" href="#id1">Region growing</a></li>
<li><a class="reference internal" href="#id2">Laplacian</a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-2-unwrapping-the-phase-with-a-large-amount-of-wrapping-effect">Test 2: Unwrapping the phase with a large amount of wrapping effect</a><ul>
<li><a class="reference internal" href="#id3">Region growing</a></li>
<li><a class="reference internal" href="#id4">Laplacian</a></li>
<li><a class="reference internal" href="#id5">Region growing</a></li>
<li><a class="reference internal" href="#id6">Laplacian</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../gui/QSM-standalone.html"
                        title="previous chapter">QSM Standalone</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../tutorial/fMRItoolkit2019/index.html"
                        title="next chapter">(f)MRI Toolkit 2019</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/demo/Choosing-a-right-phase-unwrapping-method-for-your-data.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../tutorial/fMRItoolkit2019/index.html" title="(f)MRI Toolkit 2019"
             >next</a> |</li>
        <li class="right" >
          <a href="../gui/QSM-standalone.html" title="QSM Standalone"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SEPIA 0.7 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Kwok-Shing Chan.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>