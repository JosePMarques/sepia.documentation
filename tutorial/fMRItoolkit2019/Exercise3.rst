.. _fmritoolkit2019-exercise3:

Exercise 3
==========

Objectives
----------

- Understanding 
- Gaining experience to use QSM algorithms

Data Required
^^^^^^^^^^^^^

- a 3D local field image (*Sepia_peel-4_local-field.nii.gz* in the previous exercise output directory)
- a 3D refined brain mask (*Sepia_peel-4_mask-qsm.nii.gz* in the previous exercise output directory)
- a SEPIA header (*Sepia_header.mat* in the input directory)

Estimated time
^^^^^^^^^^^^^^

Less than 15 min.

The Last Step
-------------

We can see some beautiful contrasts between brain tissues from the local (or tissue) fields obtained from the last exercise. These local fields represent all the secondary magnetic field induced by the tissues (which are our magnetic susceptibility sources), and the effect of magnetic field is actually extended beyond the source itself. 

.. note:: Think of a magnet that can attract a metal toward it even when the two objects are not intact. It is because the magnetic field generated by the magnet extends outside the magnet body itself, causing the magnetic polarisation of the metal.

We can describe the local fields generated by the magnetic susceptibility sources (:math:`\chi`) using the following equation:

.. math:: 
   Tissue field = \chi \circledast d
   :label: fcd

where :math:`d` is a unit (dipole) field that the source generated and has the following shape:

.. figure:: images/dipole_example.png
   :align: center

   Figure 1: An illustration of a unit dipole field in (i) sagittal section and (ii) surface rendered contour. Red colour represents a positive magnetic field and blue colour represents a negative magnetic field. (Reproduced from `Wang & Liu MRM 2014, Wiley <https://doi.org/10.1002/mrm.25358>`_)

Eq. :eq:`fcd` basically means that the secondary magnetic field experienced by the tissue at each location is the summation of the fields generated by all other (surrounding) sources. Since we have the prior knowledge about the shape of the magnetic field genearted by the source (which is :math:`d` , the unit dipole field) and the field generated by the tissues (result of our last exercise), mapping the magnetic susceptibility of the tissue is just the deconvolution of these two parameters (a.k.a. dipole inversion).

.. note:: Using the Fourier theorem, deconvolution can be performed by dividing the Fourier transform of the two known parameters: 

   .. math::
      \chi = F^{-1}[\frac{F(Tissue field)}{F(d)}]
      :label: di

   where :math:`F` and :math:`F^{-1}` are the Fourier and inverse Fourier transform operators.

Sounds simple, isn't it? Let's try it out!

QSM: Dipole inversion
---------------------
Now move to the **QSM** tab of SEPIA. Select the corresponding input. Change the basename of the output from *sepia* to *sepia_tkd-0*. To do exactly the operation as in Eq. :eq:`di`, set the threshold of the **TKD** algorithm to 0 and press **Start**.
     