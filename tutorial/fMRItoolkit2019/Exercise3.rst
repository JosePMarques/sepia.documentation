.. _fmritoolkit2019-exercise3:

Exercise 3
==========

Objectives
----------

- Understanding why we need to remove the background magnetic field contributions before QSM  
- Fine-tuning method parameters to improve the background field removal results

Data Required
^^^^^^^^^^^^^

- a 3D total field image (*Sepia_total-field.nii.gz* in the previous exercise output directory)
- a 3D brain mask (*Sepia_mask.nii.gz* in the previous exercise output directory)
- a SEPIA header (*Sepia_header.mat* in the input directory)

Estimated time
^^^^^^^^^^^^^^

Less than 15 min.

One more step before computing QSM but why?
-------------------------------------------

In the previous exercise display windowing had to be adjusted in order to visualize some brain structures. Why are these tissue contrasts 'hiddened' in our images?   

The data contains not only the phase generated by the brain tissues but also by the scanner hardware imperfection and fields generated at air/tissue interfaces such as sinuses and ear canals. 

These non-tissue fields, or so-called background fields, can be one or two order(s) of magnitude stronger than the tissue fields and affects the global brain tissues. 

Since we are only interested in the magnetic fields generated by the brain tissues, we have to remove these background fields before computing the QSM map. However, the background fields and tissue fields co-exist across the whole brain. 

Luckily, the background fields have quite different mathematical properties and researchers have successfully developed various algorithms to separate the tissue fields from the background fields. 

.. figure:: images/total_field_explain.png
   :align: center
   
   Figure 1: The total field we obatined from last exercise is the summation of tissue and background magnetic fields. In order to compute the magnetic susceptibility of the brain tissue correctly, the background field contributions have to be removed before the mapping the tissue susceptibilities.

Background Field Removal  
------------------------

SEPIA provides 7 methods to remove the background magnetic fields. Today we will use the Laplacian boundary values (LBV) algorithm, which is, in general, quite robust. 

Go to the **Background field removal** tab. You will see two panels as the **Phase unwrapping** tab. 

In the **I/O** panel, specify by using the open buttons:

- **Total field** image from the output directory of the previous exercise (output/Sepia_total-field.nii.gz);
- **Header** file (Sepia_header.mat) 
- **Brain mask** (output/Sepia_mask.nii.gz) which will tell the software what is not part of the background.  

Second, in the **Background field removal** panel, the 'LBV' method is shown by default. You can have three parameters to adjust. 

- 'Tolerance': a threshold to stop the algorithm. 
- 'Depth':. 
- 'Peel': the layer of boundary voxels to be removed after computing the tissue (or so-called local) fields. 

In this exercise, we will focus on the differences when using different 'Peel' values. 

- Change the **Output basename** from *Sepia* to *Sepia_peel-2* and then press the **Start** button. 

- Again, you will see the message '*Processing pipeline is completed!*' when the process is finished. 

- After the first processing is done, change the 'Peel' value to '4' and change the **Output Basename** to *Sepia_peel-4*.

- Use FSLeyes to display both output images at the same time:

  ``fsleyes Sepia_peel-2.nii.gz``

  You can do this using the '+' button in the bottom right panel and select *Sepia_peel-4.nii.gz* in the window provided. 

  .. image:: images/plus_button.png
     :align: center
 
  Adjust the display window to 'Min. -5' and 'Max. 5'. Use the 'Opacity' slide to alter the transparence of the top image. What is the main difference between the two results?

  .. image:: images/local_field_window.png
     :align: center

  Note that you can now see very clearly the contrast between grey and white matter, and veins and tissue. Other structures as the globus pallidus, red nucleus and substantia nigra are visible... but not quite normal.

  Compare the location of the edges with what you can see in the mean magnitude image. This can be computed on the terminal using:

  ``fslmaths mag.nii.gz -Tmean mag_mean.nii.gz``

Proceed to :ref:`fmritoolkit2019-exercise4`.


     